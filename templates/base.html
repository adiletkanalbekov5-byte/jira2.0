{% extends "base.html" %}

{% block content %}
<!-- Основная сетка досок -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    {% for board in boards %}
    <div class="bg-white rounded-lg shadow p-4" data-board-id="{{ board.id }}">
        <!-- Название доски -->
        <h2 class="text-xl font-bold mb-4">{{ board.name }}</h2>

        <!-- Колонки внутри доски -->
        <div class="columns space-y-4">
            {% for column in board.columns.all %}
            <div class="bg-gray-100 rounded p-2 column" data-column-id="{{ column.id }}">
                <!-- Название колонки -->
                <h3 class="font-semibold mb-2">{{ column.name }}</h3>

                <!-- Задачи внутри колонки -->
                <div class="tasks space-y-2">
                    {% for task in column.tasks.all %}
                    <div class="bg-white p-2 rounded shadow task" data-task-id="{{ task.id }}">
                        {{ task.title }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Скрипт для drag-and-drop задач через Sortable.js -->
<script>
document.querySelectorAll('.tasks').forEach(container => {
    new Sortable(container, {
        group: 'shared', // Все контейнеры с задачами в одной группе для перетаскивания
        animation: 150,  // Анимация при перемещении

        onEnd: function(evt) {
            // Получаем id задачи и колонки, куда переместили
            const taskId = evt.item.dataset.taskId;
            const columnId = evt.to.closest('.column').dataset.columnId;
            const boardId = evt.to.closest('[data-board-id]').dataset.boardId;

            // Отправляем PATCH-запрос на сервер для обновления позиции задачи
            fetch(`/api/tasks/${taskId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // Защита CSRF
                },
                body: JSON.stringify({ column: columnId, board: boardId })
            });
        }
    });
});
</script>
{% endblock %}
